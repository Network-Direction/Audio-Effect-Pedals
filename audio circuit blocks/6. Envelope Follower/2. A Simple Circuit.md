# A Simple Envelope Follower

The purpose of an envelope follower is to create an output voltage that represents the shape of an input signal.

We can start by breaking this down into the simplest components:
1. High Pass Filter
2. Rectifier

This very simple circuit will look something like this:

![image](https://github.com/user-attachments/assets/c30f5719-68dd-4d30-af16-d1f4af3d9985)


Let's break down how this works


</br></br>
## High Pass Filter

The first component is the high pass filter. The most important job this plays is to remove DC offset.

It's possible this has already been done by some external circuitry before the signal reaches the filter, so technically you don't _need_ to have this, but it's still a good idea.

The HPF also removes any very low frequencies that will act similar to DC voltage.

So what rolloff frequency should we use? As a rough idea, somwhere 15KHz or lower is good. It might depend on what you're trying to do. If you really want to track lower frequencies for some reason, you may need to adjust.

</br></br>
We also need to think about how **responsive** the filter is. Remember that capacitors have a [time constant](https://github.com/Network-Direction/Audio-Effect-Pedals/blob/Wha-Pedals/audio%20circuit%20blocks/3.%20Filters/4.%20Phase%20Shift.md). That is, it takes time for a capacitor to charge and discharge.

The _speed_ of the envelope follower, that is, how fast it _responds_ to changes in the input signal will depend on this time constant.

If we use a large resistor or capacitor in the filter, we will have a large time constant, meaning that the circuit will not respond to changes as quickly. Using smaller resistors and capacitors result in a lower time constant, which makes the circuit respond faster.

We have some say in the resistors and capacitors we use in the filter. But it's clear that smaller components will yield a smaller time constant, which improves responsiveness. We might find that different cutoff frequencies are better than others depending on our case.

Synths for example, may benefit from a very small time constant, which would mean a filter with a rolloff at around 5Hz. Guitars may be better at about 10Hz, while specific music genere's may require something else.

The simple circuit above uses a 10Hz rolloff, which seems to be a fairly nice balanced value.


</br></br>
## Rectifier

This simple circuit contains a _half-wave rectifier_. This is the single diode.

The audio signal is represented as AC, which moves in both directions. The diode allows the signal to move in one direction, but not the other.

The result is that the positive half of the signal's wave is kept, while the negative half is discarded. This is a critical step in creating a DC voltage output, which does not fluctuate between positive and negative like AC does.


</br></br>
Why a half-wave rectifier and not a full-wave rectifier?

Unlike a half-wave rectifier, a full wave rectifier keeps the negative portion of a wave, but inverts it so it's all positive.

![image](https://github.com/user-attachments/assets/22ba9414-a1e6-4159-a8c5-4213bbed1468)

In this simple circuit, a half-wave rectifier is used as it's simple. One single diode.

A full-wave rectifier can definitely be used, and it has the advantage of being more _accurate_ in a sense, as it doesn't lose any information.


</br></br>
## Testing

As a quick test, I can attach a sine wave generator as the input, and an osciloscope on the output.

The sine wave generator is creating a 2KHz signal, with a strength of 2.5v peak to peak.

For this to work, I have connected a 1M resistor between the output of the diode and ground. This is to simulate a load on the circuit. Without this, the circuit really has no idea what ground is.

The result is this:

![half-wave](https://github.com/user-attachments/assets/5290dd5f-f5d3-49e0-9171-1bf4f218af6c)

</br></br>
There are two important things to note here:
1. The output is effectively just a rectified signal. It's not much of an envelope follower yet
2. The signal is now 946mV peak to peak. We've lost a lot of signal strength

</br></br>
Why the loss of signal strength? There are two reasons.

Firstly, when the signal passes through the diode, we have to consider the forward voltage drop of the diode. It's about 0.6v for this diode, so we're down to 1.9v

Secondly, when we rectify the signal, we lose about half of the signal strength. That brings us to the 0.95v that we're seeing here.


</br></br>
So there are clearly some improvements to be made:
1. We need a smoothed output, so it's not just a rectified signal
2. We need to restore some of the lost power in the signal


</br></br>
---
# Signal Smoothing
## Smoothing an AC Signal

Signal smoothing is nice and easy. We just need to add a capacitor to the circuit.

If you're familiar with power supplies, you'll be comfortable here. An AC to DC power supply will have a bridge rectifier, followed by smoothing components, which converts the AC power to nice clean DC power.

The capacitor sits neatly at the end of the circuit, right before the load.

![image](https://github.com/user-attachments/assets/5c9d1ab3-6e6c-4fa2-b194-54c722aed324)


</br></br>
When we input our sine wave to this circuit, we now get a smoother output:

![Smoothed-2](https://github.com/user-attachments/assets/e689cf66-92b3-4eda-a1c4-74d189fbb547)

</br></br>
Granted, the input is a simple sine wave, so we won't see anything particularly exciting here. The peak voltage is still lower than hoped, clocking in at about 0.7v. We'll deal with that soon.

In this case, I'm using a fairly small capacitor for smoothing. You may need a larger one depending on what you want to do, and how smooth you want the output. You want it low enough that it's still following the wave somewhat. If you make it too big, you will just get a steady DC voltage out, like this:

![Smoothed signal](https://github.com/user-attachments/assets/c0c59c91-75a3-4dde-805b-f2b10992f17f)



</br></br>
---
# Amplification
## Opamp Amplifier

The amplification portion of the circuit is fairly straightforward. We can use an opamp to create a [non-inverting amplifier](https://github.com/Network-Direction/Audio-Effect-Pedals/blob/Wha-Pedals/audio%20circuit%20blocks/1.%20OpAmps/3.%20Amplifiers.md) like this:

![image](https://github.com/user-attachments/assets/6d34b092-2e12-41e2-923c-7c4f3296a138)

As we're working with a simple circuit for now, the gain is fixed at about 3x. A more complicated circuit might include a potentiometer to make the gain adjustable. Or, a separate gain stage could be added later on.


</br></br>
## Precision Rectifier

Using an opamp as an amplifier is good, but it's not as precice as it could be. It's compensating for a diode whose forward voltage drop may vary according to conditions such as temperature.

An alternative to using an amplifier to restore amplitude according to some gain that we're guessing at, is to compensate for the diode at the time of rectification.

This also uses an opamp in non-inverting mode:

![image](https://github.com/user-attachments/assets/b431088f-b4aa-4dfe-bcb0-aaa1dfd5f379)


</br></br>
Instead of having a diode on its own, it's now part of the opamp circuit. The Opamp will drive the output harder to compensate for any drop, and will dynamically adjust based on factors like temperature.


</br></br>
# Resources

Peak Detector Circuit - https://www.youtube.com/watch?v=jllsqRWhjGM

